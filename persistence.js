
export const DB = { KEYS: { BRIEFINGS: 'emp_briefings', MEETINGS: 'emp_meetings', USERS: 'emp_users', CHATS: 'emp_chats', ADMIN: 'emp_admin_session', USER: 'emp_user_session', SYNC: 'emp_sync_event' }, async _h(p) { if (!window.crypto || !window.crypto.subtle) return btoa(p); const m = new TextEncoder().encode(p); const b = await crypto.subtle.digest('SHA-256', m); return Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2, '0')).join('') }, _e(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML }, _g(k) { return JSON.parse(localStorage.getItem(k) || '[]') }, _s(k, d) { localStorage.setItem(k, JSON.stringify(d)); this._t(k) }, _t(k) { localStorage.setItem(this.KEYS.SYNC, Date.now() + ':' + k) }, onDataChange(cb) { window.addEventListener('storage', e => { if (e.key === this.KEYS.SYNC || e.key === this.KEYS.CHATS) cb() }) }, addBriefing(b) { const l = this._g(this.KEYS.BRIEFINGS); b.id = Date.now().toString(36); b.timestamp = new Date().toISOString(); b.status = 'NEW'; l.push(b); this._s(this.KEYS.BRIEFINGS, l); return b }, getBriefings() { return this._g(this.KEYS.BRIEFINGS).reverse() }, addMeeting(m) { const l = this._g(this.KEYS.MEETINGS); m.id = Date.now().toString(36); m.timestamp = new Date().toISOString(); m.status = 'SCHEDULED'; l.push(m); this._s(this.KEYS.MEETINGS, l); return m }, getMeetings() { return this._g(this.KEYS.MEETINGS).reverse() }, async registerUser(n, p) { const u = this._g(this.KEYS.USERS); if (u.find(x => x.name === n)) return { error: "USUÁRIO JÁ EXISTE." }; const ph = await this._h(p); const nu = { id: 'user_' + Date.now().toString(36), name: this._e(n), password: ph, joined: new Date().toISOString() }; u.push(nu); this._s(this.KEYS.USERS, u); localStorage.setItem(this.KEYS.USER, JSON.stringify(nu)); return nu }, async loginUser(n, p) { const u = this._g(this.KEYS.USERS); const ph = await this._h(p); const f = u.find(x => x.name === n && x.password === ph); if (f) { localStorage.setItem(this.KEYS.USER, JSON.stringify(f)); return f } return null }, getCurrentUser() { return JSON.parse(localStorage.getItem(this.KEYS.USER)) }, getUsers() { return this._g(this.KEYS.USERS) }, sendMessage(f, t, txt) { const c = JSON.parse(localStorage.getItem(this.KEYS.CHATS) || '{}'); let cid = (f === 'ADMIN') ? t : f; if (!c[cid]) c[cid] = []; const m = { from: f, text: this._e(txt), timestamp: new Date().toISOString() }; c[cid].push(m); localStorage.setItem(this.KEYS.CHATS, JSON.stringify(c)); return m }, getMessages(uid) { return (JSON.parse(localStorage.getItem(this.KEYS.CHATS) || '{}'))[uid] || [] }, async loginAdmin(p) { const h = await this._h(p); if (h === '482c811da5d5b4bc6d497c9c060e4514fdb2f0b70c1e874457b0553761b8f046' || h === 'dm9pZDEyMw==') { localStorage.setItem(this.KEYS.ADMIN, 'true'); return true } return false }, isAdmin() { return localStorage.getItem(this.KEYS.ADMIN) === 'true' }, logoutAdmin() { localStorage.removeItem(this.KEYS.ADMIN) } };
