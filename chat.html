<div id="void-chat-widget">

    <div id="chat-toggle" onclick="toggleChat()">
        <span>?</span>
    </div>


    <div id="chat-window">
        <div class="chat-header">
            <span>SUPORTE // ONLINE</span>
            <span style="cursor: pointer;" onclick="toggleChat()">X</span>
        </div>


        <div id="view-login"
            style="display: flex; flex-direction: column; height: 100%; justify-content: center; padding: 2rem;">
            <p style="margin-bottom: 1rem; color: #888; font-size: 0.8rem;">IDENTIFIQUE-SE</p>
            <input type="text" id="loginName" placeholder="CODNOME"
                style="margin-bottom: 0.5rem; padding: 0.5rem; background: #111; border: 1px solid #333; color: #fff; outline:none;">
            <input type="password" id="loginPass" placeholder="SENHA"
                style="margin-bottom: 1rem; padding: 0.5rem; background: #111; border: 1px solid #333; color: #fff; outline:none;">

            <button onclick="doLogin()"
                style="width: 100%; padding: 0.8rem; background: #fff; color: #000; border: none; font-weight: bold; cursor: pointer; margin-bottom: 1rem;">ENTRAR</button>
            <p style="text-align: center; color: #555; text-decoration: underline; cursor: pointer; font-size: 0.7rem;"
                onclick="switchAuth('register')">CRIAR NOVA IDENTIDADE</p>
            <p id="login-error" style="color: #f00; font-size: 0.7rem; margin-top: 0.5rem; display: none;"></p>
        </div>


        <div id="view-register"
            style="display: none; flex-direction: column; height: 100%; justify-content: center; padding: 2rem;">
            <p style="margin-bottom: 1rem; color: #888; font-size: 0.8rem;">REGISTRAR OPERADOR</p>
            <input type="text" id="regName" placeholder="NOVO CODNOME"
                style="margin-bottom: 0.5rem; padding: 0.5rem; background: #111; border: 1px solid #333; color: #fff; outline:none;">
            <input type="password" id="regPass" placeholder="CRIAR SENHA"
                style="margin-bottom: 1rem; padding: 0.5rem; background: #111; border: 1px solid #333; color: #fff; outline:none;">

            <button onclick="doRegister()"
                style="width: 100%; padding: 0.8rem; background: #0ff; color: #000; border: none; font-weight: bold; cursor: pointer; margin-bottom: 1rem;">REGISTRAR</button>
            <p style="text-align: center; color: #555; text-decoration: underline; cursor: pointer; font-size: 0.7rem;"
                onclick="switchAuth('login')">VOLTAR PARA LOGIN</p>
            <p id="reg-error" style="color: #f00; font-size: 0.7rem; margin-top: 0.5rem; display: none;"></p>
        </div>

        <div id="chat-interface" style="display: none; flex-direction: column; height: 100%;">
            <div id="user-msgs"
                style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
            </div>
            <div style="padding: 1rem; border-top: 1px solid #333; display: flex;">
                <input type="text" id="userMsgInput" placeholder="..."
                    style="flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 0.5rem; outline: none;">
                <button onclick="sendUserMsg()"
                    style="background: #0ff; color: #000; border: none; padding: 0 1rem; font-weight: bold; cursor: pointer;">></button>
            </div>
        </div>
    </div>
</div>

<style>
    #void-chat-widget {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 9999;
        font-family: 'Space Mono', monospace;
    }

    #chat-toggle {
        width: 60px;
        height: 60px;
        background: #000;
        border: 2px solid #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        transition: 0.3s;
    }

    #chat-toggle:hover {
        background: #fff;
        color: #000;
        box-shadow: 0 0 30px #fff;
    }

    #chat-toggle span {
        font-size: 1.5rem;
        font-weight: bold;
    }

    #chat-window {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 320px;
        height: 450px;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #333;
        display: none;

        flex-direction: column;
        box-shadow: -10px 10px 40px rgba(0, 0, 0, 0.8);
    }

    .chat-header {
        background: #000;
        padding: 1rem;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .msg {
        padding: 0.5rem;
        max-width: 80%;
        font-size: 0.85rem;
        word-wrap: break-word;
    }

    .msg.me {
        align-self: flex-end;
        background: #222;
        border: 1px solid #444;
        color: #fff;
    }

    .msg.support {
        align-self: flex-start;
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid #0ff;
        color: #fff;
    }
</style>

<script type="module">
    import { DB } from './persistence.js';

    let currentUser = DB.getCurrentUser();
    let pollInterval = null;

    window.toggleChat = () => {
        const win = document.getElementById('chat-window');
        const isVisible = win.style.display === 'flex';
        win.style.display = isVisible ? 'none' : 'flex';

        if (!isVisible && currentUser) {
            initChatInterface();
        }
    };

    window.switchAuth = (mode) => {
        document.getElementById('view-login').style.display = mode === 'login' ? 'flex' : 'none';
        document.getElementById('view-register').style.display = mode === 'register' ? 'flex' : 'none';


        document.getElementById('login-error').style.display = 'none';
        document.getElementById('reg-error').style.display = 'none';
    };

    if (currentUser) {
        showChatInterface();
    }

    function showChatInterface() {
        document.getElementById('view-login').style.display = 'none';
        document.getElementById('view-register').style.display = 'none';
        document.getElementById('chat-interface').style.display = 'flex';
        initChatInterface();
    }

    function showLoginError(msg) {
        const el = document.getElementById('login-error');
        el.innerText = msg;
        el.style.display = 'block';
    }

    function showRegError(msg) {
        const el = document.getElementById('reg-error');
        el.innerText = msg;
        el.style.display = 'block';
    }


    window.doLogin = async () => {
        const name = document.getElementById('loginName').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        if (!name || !pass) return showLoginError("PREENCHA OS DADOS.");

        const user = await DB.loginUser(name, pass);
        if (user) {
            currentUser = user;
            showChatInterface();
        } else {
            showLoginError("CREDENCIAIS INVÁLIDAS.");
        }
    };

    window.doRegister = async () => {
        const name = document.getElementById('regName').value.trim();
        const pass = document.getElementById('regPass').value.trim();
        if (!name || !pass) return showRegError("PREENCHA OS DADOS.");

        const res = await DB.registerUser(name, pass);
        if (res.error) {
            showRegError(res.error);
        } else {
            currentUser = res;
            showChatInterface();
        }
    };

    function initChatInterface() {
        renderMessages();

        DB.onDataChange(() => {
            renderMessages();
        });
    }

    function renderMessages() {
        if (!currentUser) return;
        const msgs = DB.getMessages(currentUser.id);
        const container = document.getElementById('user-msgs');

        container.innerHTML = msgs.map(m => `
            <div class="msg ${m.from === currentUser.id ? 'me' : 'support'}">
                <div style="font-size: 0.6em; opacity: 0.5; margin-bottom: 2px;">${m.from === currentUser.id ? 'VOCÊ' : 'SUPORTE'}</div>
                ${m.text}
            </div>
        `).join('');

        container.scrollTop = container.scrollHeight;
    }

    window.sendUserMsg = () => {
        const input = document.getElementById('userMsgInput');
        const txt = input.value.trim();
        if (!txt || !currentUser) return;

        DB.sendMessage(currentUser.id, 'ADMIN', txt);
        input.value = '';
        renderMessages();
    };
</script>
